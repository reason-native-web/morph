<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Lwt_pool (lwt.Lwt_pool)</title><link rel="stylesheet" href="../../odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">lwt</a> &#x00BB; Lwt_pool</nav><h1>Module <code>Lwt_pool</code></h1><p>External resource pools.</p><p>This module provides an abstraction for managing collections of resources. One example use case is for managing a pool of database connections, where instead of establishing a new connection each time you need one (which is expensive), you can keep a pool of opened connections and reuse ones that are free.</p><p>It also provides the capability of:</p><ul><li>specifying the maximum number of resources that the pool can manage simultaneously,</li><li>checking whether a resource is still valid before/after use, and</li><li>performing cleanup logic before dropping a resource.</li></ul><p>The following example illustrates how it is used with an imaginary <code>Db</code> module:</p><pre><code class="ml">let uri = &quot;postgresql://localhost:5432&quot;

(* Create a database connection pool with max size of 10. *)
let pool =
  Lwt_pool.create 10
    ~dispose:(fun connection -&gt; Db.close connection |&gt; Lwt.return)
    (fun () -&gt; Db.connect uri |&gt; Lwt.return)

(* Use the pool in queries. *)
let create_user name =
  Lwt_pool.use pool (fun connection -&gt;
      connection
      |&gt; Db.insert &quot;users&quot; [(&quot;name&quot;, name)]
      |&gt; Lwt.return
    )</code></pre><p>Note that this is <em>not</em> intended to keep a pool of system threads. If you want to have such pool, consider using <a href="../Lwt_preemptive/index.html"><code>Lwt_preemptive</code></a>.</p></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>'a t</span></code></dt><dd><p>A pool containing elements of type <code>'a</code>.</p></dd></dl><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : int <span>&#45;&gt;</span> <span>?&#8288;validate:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span>bool <a href="../Lwt/index.html#type-t">Lwt.t</a></span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;check:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span>(bool <span>&#45;&gt;</span> unit)</span> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <span>?&#8288;dispose:<span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span>unit <a href="../Lwt/index.html#type-t">Lwt.t</a></span>)</span></span> <span>&#45;&gt;</span> <span>(unit <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="../Lwt/index.html#type-t">Lwt.t</a></span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>create n ?check ?validate ?dispose f</code> creates a new pool with at most <code>n</code> elements. <code>f</code> is used to create a new pool element. Elements are created on demand and re-used until disposed of.</p><dl><dt>parameter validate</dt><dd><p>is called each time a pool element is accessed by <a href="index.html#val-use"><code>use</code></a>, before the element is provided to <a href="index.html#val-use"><code>use</code></a>'s callback. If <code>validate element</code> resolves to <code>true</code> the element is considered valid and is passed to the callback for use as-is. If <code>validate element</code> resolves to <code>false</code> the tested pool element is passed to <code>dispose</code> then dropped, with a new one is created to take <code>element</code>'s place in the pool. <code>validate</code> is available since Lwt 3.2.0.</p></dd></dl><dl><dt>parameter check</dt><dd><p>is called after the resolution of <a href="index.html#val-use"><code>use</code></a>'s callback when the resolution is a failed promise. <code>check element is_ok</code> must call <code>is_ok</code> exactly once with <code>true</code> if <code>element</code> is still valid and <code>false</code> otherwise. If <code>check</code> calls <code>is_ok false</code> then <code>dispose</code> will be run on <code>element</code> and the element will not be returned to the pool.</p></dd></dl><dl><dt>parameter dispose</dt><dd><p>is used as described above and by <a href="index.html#val-clear"><code>clear</code></a> to dispose of all elements in a pool. <code>dispose</code> is <b>not</b> guaranteed to be called on the elements in a pool when the pool is garbage collected. <a href="index.html#val-clear"><code>clear</code></a> should be used if the elements of the pool need to be explicitly disposed of.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-use"><a href="#val-use" class="anchor"></a><code><span class="keyword">val</span> use : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>(<span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../Lwt/index.html#type-t">Lwt.t</a></span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> <a href="../Lwt/index.html#type-t">Lwt.t</a></span></code></dt><dd><p><code>use p f</code> requests one free element of the pool <code>p</code> and gives it to the function <code>f</code>. The element is put back into the pool after the promise created by <code>f</code> completes.</p><p>In the case that <code>p</code> is exhausted and the maximum number of elements is reached, <code>use</code> will wait until one becomes free.</p></dd></dl><dl><dt class="spec value" id="val-clear"><a href="#val-clear" class="anchor"></a><code><span class="keyword">val</span> clear : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>unit <a href="../Lwt/index.html#type-t">Lwt.t</a></span></code></dt><dd><p><code>clear p</code> will clear all elements in <code>p</code>, calling the <code>dispose</code> function associated with <code>p</code> on each of the cleared elements. Any elements from <code>p</code> which are currently in use will be disposed of once they are released.</p><p>The next call to <code>use p</code> after <code>clear p</code> guarantees a freshly created pool element.</p><p>Disposals are performed sequentially in an undefined order.</p><dl><dt>since</dt><dd>3.2.0</dd></dl></dd></dl><dl><dt class="spec value" id="val-wait_queue_length"><a href="#val-wait_queue_length" class="anchor"></a><code><span class="keyword">val</span> wait_queue_length : <span><span class="type-var">_</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> int</code></dt><dd><p><code>wait_queue_length p</code> returns the number of <a href="index.html#val-use"><code>use</code></a> requests currently waiting for an element of the pool <code>p</code> to become available.</p><dl><dt>since</dt><dd>3.2.0</dd></dl></dd></dl></div></body></html>
